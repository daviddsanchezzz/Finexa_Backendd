generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////////////

enum BudgetPeriod {
  daily
  weekly
  monthly
  yearly
}

enum DebtType {
  loan
  personal
}

enum DebtDirection {
  i_ow
  they_owe
}

enum DebtStatus {
  active   // deuda en curso
  paid     // totalmente pagada (pero no cerrada)
  closed   // cerrada manualmente por el usuario
}

enum WalletKind {
  cash
  investment
}

enum CategoryKind {
  travel
  debts
  application
  personal
  investment
}

enum InvestmentAssetType {
  crypto
  etf
  stock
  fund
  custom
  cash
}

enum InvestmentRiskType {
  fixed_income
  variable_income
}

enum InvestmentOperationType {
  transfer_in
  transfer_out
  buy
  sell
  swap_in
  swap_out
}




//////////////////////////////////////////////////////////////
// MODELOS PRINCIPALES
//////////////////////////////////////////////////////////////

model User {
  id            Int            @id @default(autoincrement())
  name          String
  email         String         @unique
  password      String
  language      String?        @default("es")
  currency      String?        @default("EUR")
  theme         String?        @default("light")

  wallets       Wallet[]       @relation("UserWallets")
  walletShares  WalletShare[]
  budgets       Budget[]
  notifications Notification[]
  categories    Category[]
  transactions  Transaction[]
  debts         Debt[]         // üëà RELACI√ìN INVERSA A Debt.user

  trips         Trip[]

  refreshToken  String?

  manualMonthData ManualMonthData[]

  investmentAssets     InvestmentAsset[]
  investmentValuations InvestmentValuationSnapshot[]
  investmentOperations InvestmentOperation[]


  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     Int?
  active        Boolean        @default(true)
}

//////////////////////////////////////////////////////////////
// CARTERAS
//////////////////////////////////////////////////////////////

model Wallet {
  id           Int           @id @default(autoincrement())
  name         String
  description  String?
  emoji        String
  balance      Float         @default(0)
  currency     String        @default("EUR")

  sharedWith   WalletShare[]
  budgets      Budget[]

  userId       Int
  user         User          @relation("UserWallets", fields: [userId], references: [id])

  kind         WalletKind @default(cash)

  transactions        Transaction[] @relation("TransactionWallet")       // income/expense
  transactionsFrom    Transaction[] @relation("TransactionFromWallet")   // transfer origen
  transactionsTo      Transaction[] @relation("TransactionToWallet")     // transfer destino

  position     Int           @default(0)

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  createdBy    Int?
  active       Boolean       @default(true)

  @@index([userId, position])
}

model WalletShare {
  id        Int      @id @default(autoincrement())
  walletId  Int
  userId    Int
  role      String   @default("viewer")

  wallet    Wallet   @relation(fields: [walletId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int?
  active    Boolean  @default(true)
}

//////////////////////////////////////////////////////////////
// CATEGOR√çAS Y SUBCATEGOR√çAS
//////////////////////////////////////////////////////////////

model Category {
  id            Int           @id @default(autoincrement())
  name          String
  type          String        // "income" o "expense"
  emoji         String?
  color         String?

  subcategories Subcategory[]
  userId        Int?
  user          User?         @relation(fields: [userId], references: [id])
  transactions  Transaction[]
  budgets       Budget[]

  kind          CategoryKind @default(personal)  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  createdBy     Int?
  active        Boolean       @default(true)
  position      Int           @default(0)

  @@index([userId, type, position])
}

model Subcategory {
  id           Int           @id @default(autoincrement())
  name         String
  emoji        String?
  color        String?

  categoryId   Int
  category     Category      @relation(fields: [categoryId], references: [id])

  transactions Transaction[]

  debtExpenseLinks Debt[] @relation("DebtExpenseSubcategory")
  debtIncomeLinks  Debt[] @relation("DebtIncomeSubcategory")

  subcategoryId Debt [] @relation("DebtSubcategory")


  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  createdBy    Int?
  active       Boolean       @default(true)
  position     Int           @default(0)

  @@index([categoryId, position])
}

//////////////////////////////////////////////////////////////
// DEUDAS
//////////////////////////////////////////////////////////////

model Debt {
  id               Int            @id @default(autoincrement())

  userId           Int
  user             User           @relation(fields: [userId], references: [id])

  type             DebtType       @default(loan)
  direction        DebtDirection  @default(i_ow)
  status           DebtStatus     @default(active)

  name             String
  entity           String
  emoji            String?
  color            String?

  totalAmount      Float
  payed            Float?         @default(0)
  remainingAmount  Float

  interestRate     Float?
  monthlyPayment   Float?
  startDate        DateTime?
  nextDueDate      DateTime?
  installmentsPaid Int?           @default(0)

  subcategoryId Int?
  subcategory   Subcategory? @relation("DebtSubcategory", fields: [subcategoryId], references: [id])

  expenseSubcategoryId Int?
  expenseSubcategory   Subcategory? @relation("DebtExpenseSubcategory", fields: [expenseSubcategoryId], references: [id])

  incomeSubcategoryId  Int?
  incomeSubcategory    Subcategory? @relation("DebtIncomeSubcategory", fields: [incomeSubcategoryId], references: [id])

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  createdBy        Int?
  active           Boolean        @default(true)

  @@index([userId])
}

//////////////////////////////////////////////////////////////
// TRANSACCIONES
//////////////////////////////////////////////////////////////
model Transaction {
  id            Int          @id @default(autoincrement())
  type          String
  amount        Float
  description   String?
  date          DateTime     @default(now())
  isRecurring   Boolean      @default(false)
  recurrence    String?
  parentId   Int?
  parent     Transaction?   @relation("RecurringParent", fields: [parentId], references: [id])
  children   Transaction[]  @relation("RecurringParent")
 

  categoryId    Int?
  category      Category?    @relation(fields: [categoryId], references: [id])

  subcategoryId Int?
  subcategory   Subcategory? @relation(fields: [subcategoryId], references: [id])

  fromWalletId  Int?
  fromWallet    Wallet?      @relation("TransactionFromWallet", fields: [fromWalletId], references: [id])

  toWalletId    Int?
  toWallet      Wallet?      @relation("TransactionToWallet", fields: [toWalletId], references: [id])

  walletId      Int?
  wallet        Wallet?      @relation("TransactionWallet", fields: [walletId], references: [id])

  userId        Int
  user          User         @relation(fields: [userId], references: [id])

  tripId        Int?
  trip          Trip?        @relation(fields: [tripId], references: [id])

  investmentAssetId Int?
  investmentAsset   InvestmentAsset? @relation(fields: [investmentAssetId], references: [id])
  investmentOperation InvestmentOperation?
  source    String   @default("user") // "user" | "investment"

  excludeFromStats Boolean @default(false)

  // üëá NUEVO: relaci√≥n inversa con TripPlanItem
  planItems     TripPlanItem[]

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  createdBy     Int?
  active        Boolean      @default(true)

  @@index([subcategoryId])
}


//////////////////////////////////////////////////////////////
// PRESUPUESTOS
//////////////////////////////////////////////////////////////

model Budget {
  id         Int          @id @default(autoincrement())
  name       String?
  period     BudgetPeriod @default(monthly)
  limit      Float
  startDate  DateTime

  categoryId Int?
  category   Category?    @relation(fields: [categoryId], references: [id])

  walletId   Int?
  wallet     Wallet?      @relation(fields: [walletId], references: [id])

  userId     Int
  user       User         @relation(fields: [userId], references: [id])

  active     Boolean      @default(true)
  createdBy  Int?

  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
}

//////////////////////////////////////////////////////////////
// NOTIFICACIONES
//////////////////////////////////////////////////////////////

model Notification {
  id        Int      @id @default(autoincrement())
  title     String
  message   String
  type      String?
  read      Boolean  @default(false)

  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int?
  active    Boolean  @default(true)
}

//////////////////////////////////////////////////////////////
// RES√öMENES MANUALES
//////////////////////////////////////////////////////////////

model ManualMonthData {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation(fields: [userId], references: [id])

  year         Int      // 2021
  month        Int      // 0‚Äì11 (0 = enero)

  income       Float?   @default(0)
  expense      Float?   @default(0)
  finalBalance Float?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  createdBy    Int?
  active       Boolean  @default(true)

  @@unique([userId, year, month])
}

// =========================
// Trips
// =========================

enum Continent {
  europe
  africa
  asia
  north_america
  south_america
  oceania
  antarctica
}

enum TripStatus {
  wishlist
  planning
  seen
}

model Trip {
  id          Int        @id @default(autoincrement())
  userId      Int

  name        String
  destination String?    // ISO country code (ES, PL...)

  startDate   DateTime?
  endDate     DateTime?

  companions  String[]
  status      TripStatus @default(wishlist)

  cost        Float      @default(0)
  budget      Float?

  continent   Continent?
  year        Int?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user        User       @relation(fields: [userId], references: [id])

  notes       TripNote[]
  tasks       TripTask[]
  transactions Transaction[]
  planItems   TripPlanItem[]
}

// =========================
// Plan Items (base)
// =========================

enum TripPlanItemType {
  // Logistics ‚Äúgrandes‚Äù
  flight
  accommodation
  transport_destination   // tren/bus/coche (al destino)
  transport_local         // dentro del destino

  // Culture & tourism
  museum
  monument
  viewpoint
  free_tour
  guided_tour             // ‚úÖ a√±adido (engloba free/paid si quieres)

  // Leisure / entertainment
  concert
  sport                   // ‚úÖ a√±adido
  bar_party
  nightlife               // ‚úÖ a√±adido

  // Nature
  beach
  hike                    // ‚úÖ a√±adido

  // Gastronomy
  restaurant
  cafe                    // ‚úÖ a√±adido
  market                  // ‚úÖ a√±adido

  // Shopping
  shopping

  // Excursions / special
  day_trip                // ‚úÖ a√±adido

  // Generic
  activity                // ‚úÖ a√±adido (actividad gen√©rica)
  expense                 // ‚úÖ a√±adido (gasto sin actividad)
  other
}


model TripPlanItem {
  id            Int              @id @default(autoincrement())
  tripId        Int

  type          TripPlanItemType
  title         String

  // viejos (NO borrar a√∫n)
  date      DateTime?
  startTime DateTime?
  endTime   DateTime?

  // ‚úÖ Tiempo ‚Äúpotente‚Äù
  day           DateTime?        // d√≠a principal (normaliza a 00:00)
  startAt       DateTime?
  endAt         DateTime?
  timezone      String?          // √∫til para mostrar bien (Europe/Madrid)

  location      String?
  notes         String?

  // ‚úÖ dinero
  cost          Decimal?
  payed         Boolean?         @default(false)
  currency      String?          // "EUR"
  logistics     Boolean          @default(false)
  paymentStatus PaymentStatus    @default(pending)

  // ‚úÖ para guardar cualquier cosa extra sin migraciones
  metadata      Json?            @db.JsonB

  // link con un gasto
  transactionId Int?
  transaction   Transaction?     @relation(fields: [transactionId], references: [id])

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  trip          Trip             @relation(fields: [tripId], references: [id], onDelete: Cascade)

  // ‚úÖ details 1-1 seg√∫n tipo
  flightDetails        FlightDetails?
  accommodationDetails AccommodationDetails?
  destinationTransport DestinationTransportDetails?
 expenseDetails ExpenseDetails?

  attachments Attachment[]

  @@index([tripId, type])
  @@index([tripId, startAt])
  @@index([tripId, day])
}

enum FlightProvider {
  aerodatabox
  manual
  other
}

model FlightDetails {
  planItemId Int @id

  provider     FlightProvider @default(aerodatabox)
  status       String?
  lastUpdatedUtc DateTime?

  flightNumberRaw  String?   // "FR 6341"
  flightNumberIata String?   // "FR6341"
  airlineName      String?
  airlineIata      String?

  fromIata   String?
  toIata     String?
  fromName   String?
  toName     String?
  fromCity   String?
  toCity     String?
  depTz      String?
  arrTz      String?

  depTerminal String?
  arrTerminal String?

  aircraftModel String?

  // tiempos (schedule/estimated/actual por si ma√±ana ampl√≠as)
  schedDepAt DateTime?
  schedArrAt DateTime?
  estDepAt   DateTime?
  estArrAt   DateTime?
  actDepAt   DateTime?
  actArrAt   DateTime?

  providerRaw Json? @db.JsonB

  planItem TripPlanItem @relation(fields: [planItemId], references: [id], onDelete: Cascade)

  @@index([flightNumberIata])
  @@index([airlineIata])
  @@index([fromIata, toIata])
  @@index([schedDepAt])
}

enum RoomType {
  single
  double
  twin
  triple
  family
  suite
  apartment
  dorm
}

enum BathroomType {
  private
  shared
}

model AccommodationDetails {
  planItemId Int @id

  name      String?
  address   String?
  city      String?
  country   String?

  checkInAt  DateTime?
  checkOutAt DateTime?

  guests     Int?
  rooms      Int?

  roomType      RoomType?
  bathroomType  BathroomType?

  bookingRef String?
  phone      String?
  website    String?

  metadata   Json? @db.JsonB

  planItem TripPlanItem @relation(fields: [planItemId], references: [id], onDelete: Cascade)

  @@index([checkInAt])
  @@index([checkOutAt])
  @@index([roomType])
  @@index([bathroomType])
}

enum DestinationTransportMode {
  train
  bus
  car
  other
}

model DestinationTransportDetails {
  planItemId Int @id

  mode       DestinationTransportMode
  company    String?
  bookingRef String?

  fromName   String?
  toName     String?

  depAt      DateTime?
  arrAt      DateTime?

  metadata   Json? @db.JsonB

  planItem TripPlanItem @relation(fields: [planItemId], references: [id], onDelete: Cascade)

  @@index([mode])
  @@index([depAt])
}

enum BudgetCategoryType {
  accommodation
  transport_main
  transport_local
  food
  activities
  leisure
  shopping
  other
}

model ExpenseDetails {
  planItemId Int @id

  category   BudgetCategoryType
  planItem TripPlanItem @relation(fields: [planItemId], references: [id], onDelete: Cascade)

  @@index([category])
}


model Attachment {
  id              Int @id @default(autoincrement())

  // uno de estos dos debe estar informado
  planItemId      Int?

  kind      String
  url       String
  filename  String?
  mimeType  String?
  sizeBytes Int?
  metadata  Json? @db.JsonB

  createdAt DateTime @default(now())

  planItem      TripPlanItem?   @relation(fields: [planItemId], references: [id], onDelete: Cascade)

  @@index([planItemId])
}

model TripNote {
  id        Int      @id @default(autoincrement())
  tripId    Int

  title     String?
  body      String
  pinned    Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
}

model TripTask {
  id        Int        @id @default(autoincrement())
  tripId    Int

  title     String
  status    TaskStatus @default(to_do)

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  trip      Trip       @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId, status])
}


enum TaskStatus {
  to_do
  done
}

enum PaymentStatus {
  pending
  paid
}




model InvestmentAsset {
  id        Int                 @id @default(autoincrement())
  userId    Int
  user      User                @relation(fields: [userId], references: [id])

  name      String              // "Bitcoin", "Crypto gen√©rico"
  description    String?             // "BTC", opcional
  type      InvestmentAssetType @default(custom)
  riskType  InvestmentRiskType?
  currency  String              @default("EUR")
  quantity  Decimal             @default(0)
  identificator String?

  initialInvested Float         @default(0) // üëà NUEVO (antes de usar la app)
  operations InvestmentOperation[]

  transactions Transaction[]   // transferencias que apuntan a este asset
  valuations   InvestmentValuationSnapshot[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  active    Boolean  @default(true)

  @@unique([userId, name])
}

model InvestmentValuationSnapshot {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  assetId   Int
  asset     InvestmentAsset @relation(fields: [assetId], references: [id])

  date      DateTime   // fin de mes
  value     Decimal
  currency  String     @default("EUR")

  unitPrice Decimal?
  quantity Decimal?
  
  source String  @default("Manual")

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  active    Boolean    @default(true)

  @@unique([userId, assetId, date])
  @@index([userId, date])
}

model InvestmentOperation {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  assetId   Int
  asset     InvestmentAsset @relation(fields: [assetId], references: [id])

  type      InvestmentOperationType
  date      DateTime @default(now())

  amount    Float
  fee       Float?   @default(0)

  // Link opcional a Transaction (para ventas/aportes con movimiento de wallet)
  transactionId Int?   @unique
  transaction   Transaction? @relation(fields: [transactionId], references: [id])

  swapGroupId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  active    Boolean  @default(true)

  @@index([userId, assetId, date])
}

model PortfolioSnapshot {
  id         Int      @id @default(autoincrement())
  userId     Int
  date       DateTime // cierre de mes (por ejemplo 2026-01-31T00:00:00Z o 23:59:59Z, pero consistente)
  totalValue Float
  currency   String   @default("EUR")

  // editable
  isAuto     Boolean  @default(true)
  isEdited   Boolean  @default(false)
  editedValue Float?
  editedAt   DateTime?
  note       String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  active     Boolean  @default(true)

  @@unique([userId, date])
  @@index([userId, date])
}



model MonthlyReport {
  id        Int      @id @default(autoincrement())
  userId    Int
  month     String   // "YYYY-MM"
  filePath  String   // ruta local o key S3
  createdAt DateTime @default(now())

  @@unique([userId, month])
  @@index([userId, month])
}

enum AllocationCategory {
  expense
  investment
  savings
}

model AllocationPlan {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  income    Decimal  @db.Decimal(14, 2)
  currency  String   @default("EUR")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     AllocationItem[]

  @@index([userId])
}

model AllocationItem {
  id        Int      @id @default(autoincrement())
  planId    Int
  category  AllocationCategory
  name      String
  amount    Decimal  @db.Decimal(14, 2)
  order     Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plan      AllocationPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId, category])
}
